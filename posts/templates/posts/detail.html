{% extends 'base.html' %}
{% load static %}

{% block content %}
  <h1>Detail</h1>

  <p class="">
    작성자 - 
    <a href="{% url 'accounts:profile' post.user.username %}">{{ post.user }}</a>
  </p>
  <p class="">
    제목 - 
    {{ post.title }}
  </p>

  {% comment %} post.likes {% endcomment %}

  <form id="post-likeform" data-post-id="{{ post.pk }}">
    {% csrf_token %}
    {% if request.user.is_authenticated %}
      {% if request.user in post.like_users.all %}
        <button type="submit" class=" btn btn-link text-danger"><i class="bi bi-heart-fill"></i></button>
      {% else %}
        <button type="submit" class=" btn btn-link text-danger"><i class="bi bi-heart"></i></button>
      {% endif %}
    {% else %}
      <button type="submit" class=" btn btn-link text-danger" disabled="disabled"><i class="bi bi-heart"></i></button>  
    {% endif %}
    <span id="post-likescount">{{ post.like_users.count }}</span>
  </form>

  <div class="d-flex justify-content-center">

    <div class="d-flex flex-column">
      {% if post.select1_image %}
      <img src="{{ post.select1_image.url }}" alt="image" class="select-image">
      {% else %}
      <img src="{% static 'no-img.jpg' %}" alt="no image" class="select-image">
      {% endif %}
      <form action="{% url 'posts:answer' post.pk post.select1_content %}" method="post">
        {% csrf_token %}
        <button type="submit" class="container-fluid rounded-3 btn btn-sm btn-primary ps-1 pe-1"
        {% if request.user in post.select1_user.all or request.user in post.select2_user.all %}
          disabled="disabled"
        {% endif %}
        >{{ post.select1_content }} - {{ post.select1_user.all.count }}</button>
      </form>
    </div>
  
    <div class="d-flex flex-column">
      {% if post.select2_image %}
        <img src="{{ post.select2_image.url }}" alt="image" class="select-image">
      {% else %}
        <img src="{% static 'no-img.jpg' %}" alt="no image" class="select-image">
      {% endif %}
      <form action="{% url 'posts:answer' post.pk post.select2_content %}" method="post">
        {% csrf_token %}
        <button type="submit" class="container-fluid rounded-3 btn btn-sm btn-secondary ps-1 pe-1"
        {% if request.user in post.select1_user.all or request.user in post.select2_user.all %}
          disabled="disabled"
        {% endif %}
        >{{ post.select2_content }} - {{ post.select2_user.all.count }}</button>
      </form>
    </div>

  </div>

  <hr>

  <form action="{% url 'posts:comment_create' post.pk %}" method="POST">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <input type="submit" value="댓글 작성" class="btn btn-sm btn-outline-primary">
  </form>

  <hr>

  {% for comment in comments %}

    <div class="d-flex justify-content-between">
      <p>작성자 - {{ comment.user }}</p>
      <div>
        {% if request.user == comment.user %}
          <form action="{% url 'posts:comment_delete' post.pk comment.pk %}" method="POST">
            {% csrf_token %}
            <input type="submit" value="댓글 삭제" class="btn btn-sm btn-outline-danger" onclick="return confirm('삭제하시겠습니까?')">
          </form>
        {% endif %}
      </div>
    </div>

    <p>{{ comment.content }}</p>

   {% if request.user.is_authenticated %}
     <form class="comment-likeform" id="commentlike-{{ comment.pk }}" data-comment-id="{{ comment.pk }}" data-post-id="{{ post.pk }}">
       {% csrf_token %}
       {% if request.user in comment.like_users.all %}
         <button type="submit" class="btn btn-link text-danger"><i class="bi bi-heart-fill"></i></button>
       {% else %}
         <button type="submit" class="btn btn-link text-danger"><i class="bi bi-heart"></i></button>
       {% endif %}
   {% else %}
     <button type="submit" class=" btn btn-link text-danger" disabled="disabled"><i class="bi bi-heart"></i></button> 
   {% endif %}
     <span class="like-{{ comment.pk }}">{{ comment.like_users.count }}</span>
   </form>
      
    
    
    <hr>
  {% endfor %}
  <script>
    const postform = document.querySelector('#post-likeform')
    const commentforms = document.querySelectorAll('.comment-likeform')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

    postform.addEventListener('submit', function (event) {
      event.preventDefault()
      const postId = event.target.dataset.postId
      axios({
        method: 'post',
        url: `/posts/${postId}/likes/`,
        headers: {'X-CSRFToken': csrftoken},
      })
        .then((response) => {
          const isLiked = response.data.is_liked
          const postlikesCountTag = document.querySelector('#post-likescount')
          const postlikesCountData = response.data.likes_count
          const likeBtn = document.querySelector('#post-likeform > button[type=submit] > i')
          
          if (isLiked === true) {
            likeBtn.className = 'bi bi-heart-fill'
          } else {
            likeBtn.className = 'bi bi-heart'
          }
        
          postlikesCountTag.textContent = postlikesCountData
        })
        .catch((error) => {
          console.log(error.response)
        })
    })

    commentforms.forEach((commentform) => {
      commentform.addEventListener('submit', function (event) {
        event.preventDefault()
        const commentId = event.target.dataset.commentId
        const postId = event.target.dataset.postId
        axios({
          method:'post',
          url:`/posts/${postId}/comments/${commentId}/likes/`,
          headers: {'X-CSRFToken': csrftoken},
        })
          .then((response) => {
            const isLiked = response.data.is_liked
            const commentLikesCountTag = document.querySelector(`.like-${commentId}`)
            const commentLikesCountData = response.data.likes_count
            const likeBtn = document.querySelector(`#commentlike-${commentId} > button[type=submit] > i`)
            
            if (isLiked) {
              likeBtn.className = 'bi bi-heart-fill'
            } else {
              likeBtn.className = 'bi bi-heart'
            }
            commentLikesCountTag.textContent = commentLikesCountData
          })
          .catch((error) => {
            console.log(error.response)
          })
      })

    })
  </script>
{% endblock content %}